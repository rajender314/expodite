<mat-toolbar>
  <div class="flex-fixed-header menu-title">
    <h2 style="font-weight: 400" title="{{ addContainers }}">
      {{ addContainers }}
    </h2>
  </div>
</mat-toolbar>

<mat-dialog-content>
  <mat-spinner
    class="medium-spinner page-fixed"
    *ngIf="dialogueLoading"
  ></mat-spinner>
  <div [formGroup]="containerForm">
    <div
      class="min-container"
      [class.user-footer]="containerForm.dirty"
      formArrayName="containerItem"
      *ngFor="
        let item of containerForm.get('containerItem')['controls'];
        let i = index
      "
      style="
        border-bottom: 1px solid #bdc4cc;
        padding-bottom: 15px;
        padding-top: 15px;
      "
    >
      <div [formGroupName]="i">
        <!-- <div class="ex-row">
          <mat-checkbox
            class="example-margin"
            formControlName="palletType"
            (change)="changePackageType($event, i)"
            [(ngModel)]="item.value.palletType"
            >Pallet</mat-checkbox
          >
        </div> -->

        <div class="ex-row">
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label custom-placeholder mandatory">
                Packaging</mat-label
              >
              <mat-icon matSuffix class="icon" title="Name of the Package "
                >info</mat-icon
              >
            </div>
            <input
              matInput
              placeholder="Name"
              formControlName="name"
              maxLength="15"
              type="text"
              class="fieldInput"
            />
            <mat-error
              *ngIf="
                item.controls.name.hasError('specialcharacters') ||
                item.controls.name.hasError('whitespace')
              "
            >
              Please Enter Valid Package
            </mat-error>
          </mat-form-field>
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory"
                >Tare weight of {{ item.value.name }} (kgs)</mat-label
              >
            </div>
            <input
              type="number"
              matInput
              placeholder="Tare weight"
              formControlName="tare_weight"
              id="tare_weight"
              step="0.01"
            />
            <mat-error *ngIf="item.controls.tare_weight.hasError('required')">
              Please Enter Tare Weight
            </mat-error>
            <mat-error
              *ngIf="item.controls.tare_weight.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
            <mat-error
              *ngIf="
                !item.controls.tare_weight.hasError('min') &&
                item.controls.tare_weight.hasError('pattern')
              "
              style="text-transform: none"
            >
              Please Enter Up To 8 Characters With 4 Decimals Max</mat-error
            >
          </mat-form-field>
        </div>
        <div class="ex-row">
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label
                class="custom-label mandatory"
                style="text-transform: unset"
                >Unit of Measurement</mat-label
              >
              <mat-icon
                matSuffix
                class="icon"
                title="UOM for package dimensions"
                >info</mat-icon
              >
            </div>
            <mat-select
              placeholder="Unit of Measurement"
              formControlName="uom_id"
              (selectionChange)="selectType($event, i)"
            >
              <mat-option
                [value]="stat.id"
                *ngFor="let stat of adminService.uomData"
                [innerHtml]="stat.name"
              ></mat-option>
            </mat-select>

            <mat-error *ngIf="item.controls.uom_id.hasError('required')">
              Please Select UOM
            </mat-error>
          </mat-form-field>
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory text-transform-none">
                {{ language.defaults.height }}&nbsp;<span
                  *ngIf="item.value.selectUnits"
                  >({{ item.value.selectUnits }})</span
                >
              </mat-label>
            </div>
            <input
              matInput
              type="number"
              min="0"
              max="9999.99"
              step="0.01"
              placeholder="Height"
              formControlName="height"
              id="containerHeight"
            />
            <mat-error *ngIf="item.controls.height.hasError('required')">
              Please Enter Height
            </mat-error>
            <mat-error
              *ngIf="item.controls.height.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
            <mat-error
              *ngIf="
                !item.controls.height.hasError('min') &&
                item.controls.height.hasError('pattern')
              "
            >
              Please Enter Up To 4 Characters With 4 Decimals Max</mat-error
            >
          </mat-form-field>
        </div>
        <div class="ex-row">
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory text-transform-none">
                {{ language.defaults.width }}&nbsp;
                <span *ngIf="item.value.selectUnits"
                  >({{ item.value.selectUnits }})</span
                >
              </mat-label>
            </div>
            <input
              matInput
              type="number"
              min="0"
              max=""
              step="0.01"
              placeholder="Width"
              formControlName="weight"
              id="containerWeight"
            />
            <mat-error *ngIf="item.controls.weight.hasError('required')">
              Please Enter Width
            </mat-error>
            <mat-error
              *ngIf="item.controls.weight.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
            <mat-error
              *ngIf="
                !item.controls.weight.hasError('min') &&
                item.controls.weight.hasError('pattern')
              "
              style="text-transform: none"
            >
              Please Enter Up To 4 Characters With 4 Decimals Max</mat-error
            >
          </mat-form-field>
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            step="0.01"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory text-transform-none">
                {{ language.defaults.depth }}&nbsp;<span
                  *ngIf="item.value.selectUnits"
                  >({{ item.value.selectUnits }})</span
                >
              </mat-label>
            </div>
            <input
              matInput
              type="number"
              min="0"
              max="99999999999"
              step="0.01"
              placeholder="Depth"
              formControlName="dimensions"
              id="containerDimensions"
            />
            <mat-error *ngIf="item.controls.dimensions.hasError('required')">
              Please Enter Depth
            </mat-error>
            <mat-error
              *ngIf="item.controls.dimensions.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
            <mat-error
              *ngIf="
                !item.controls.dimensions.hasError('min') &&
                item.controls.dimensions.hasError('pattern')
              "
              style="text-transform: none"
            >
              Please Enter Up To 4 Characters With 4 Decimals Max</mat-error
            >
          </mat-form-field>
        </div>

        <div class="ex-row">
          <mat-form-field
            class="custom-input-field grid-full"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label">Inner Description</mat-label>
            </div>
            <textarea
              matInput
              maxlength="255"
              placeholder="Inner Description"
              formControlName="inner_description"
              id="ContainerDesc"
            ></textarea>
          </mat-form-field>
        </div>
      </div>
      <div class="products-table">
        <div
          class="divTable"
          [formGroup]="productsDynamicForm"
          style="border: 1px solid #e3e3e3; table-layout: auto"
        >
          <div class="divTableRow product-table-header">
            <div
              class="divTableCell product-data-cell"
              style="text-align: left; max-width: 350px"
            >
              Product Details
            </div>
            <div
              class="divTableCell"
              style="text-align: left; max-width: 120px"
            >
              Quantity
            </div>
            <div
              class="divTableCell"
              style="text-align: left; max-width: 120px"
            >
              Unit Weight
            </div>
            <div
              class="divTableCell"
              style="text-align: left; max-width: 120px"
            >
              Net Weight
            </div>
            <div class="divTableCell" style="text-align: left"></div>
          </div>
          <div
            class="divTableBody"
            formArrayName="productItem"
            *ngFor="
              let item of productsDynamicForm.get('productItem')['controls'];
              let i = index
            "
          >
            <div class="divTableRow" [formGroupName]="i">
              <div
                class="divTableCell product-data-cell"
                style="max-width: 350px"
              >
                <mat-form-field
                  class="custom-input mandatory products"
                  floatLabel="never"
                  style="
                    width: 100%;
                    margin-top: 0px;
                    display: flex;
                    align-items: center;
                  "
                >
                  <input
                    placeholder="Select Product(s)"
                    matInput
                    [matAutocomplete]="product"
                    [value]="item.value.name"
                    (keyup)="searchProducts($event.target.value)"
                    (click)="changeIndex(i)"
                    (focus)="searchProducts($event.target.value)"
                  />
                  <button
                    mat-button
                    matSuffix
                    mat-icon-button
                    aria-label="Clear"
                    (click)="changeIndex(i)"
                    style="
                      display: flex;
                      align-items: center;
                      padding-top: 14px;
                    "
                  >
                    <mat-icon>keyboard_arrow_down</mat-icon>
                  </button>
                  <mat-autocomplete #product="matAutocomplete" auto>
                    <!-- *ngFor="let product of items | keyvalue" -->
                    <mat-option
                      (onSelectionChange)="changeProduct(product, i)"
                      class="products-custom-mat-option"
                      *ngFor="let product of filteredItems"
                      [value]="product.name"
                      style="border-bottom: 1px solid #ccc; padding: 12px"
                    >
                      <div
                        style="
                          display: flex;
                          align-items: center;
                          justify-content: flex-start;
                          line-height: 1.5;
                          margin-bottom: 8px;
                        "
                      >
                        <span
                          style="font-size: 16px; line-height: 1.5; flex: 1"
                          >{{ product.name }}</span
                        >
                        <span
                          style="
                            float: right;
                            font-size: 14px;
                            line-height: 1.3;
                          "
                        >
                          {{ product.remain_qty }}
                          <!-- {{
                            data?.productsCount?.has(product.value.name)
                              ? editProducts?.has(product.value.name)
                                ? editProducts.get(product.value.name) +
                                  product.value.product_quantity -
                                  data.productsCount.get(product.value.name)
                                : product.value.product_quantity -
                                  data.productsCount.get(product.value.name)
                              : product.value.remain_qty
                          }} -->
                        </span>
                      </div>
                      <span
                        style="
                          display: block;
                          font-weight: 300;
                          font-size: 14px;
                          line-height: 1.5;
                        "
                        >{{ product.description }}</span
                      >
                      <!-- <div class="product-title">
                                        <div> 
                                          <span class="product-name product-name-overlap"> {{product.name}}</span><span class="product-units">{{product.product_quantity}}</span></div>
                                         <span class="product-rate">{{product.remain_qty}} </span>
                                     </div> -->
                    </mat-option>
                  </mat-autocomplete>
                </mat-form-field>
              </div>
              <div class="divTableCell">
                <mat-form-field
                  class="custom-input mandatory"
                  floatLabel="never"
                  style="margin-top: 0px; max-width: 120px"
                >
                  <input
                    [readonly]="item.value.name == ''"
                    [class.disableClass]="item.value.name == ''"
                    (wheel)="onWheel($event)"
                    matInput
                    formControlName="quantity"
                    placeholder="quantity"
                    [value]="item.value.quantity"
                    class="input-right"
                    type="number"
                    oninput="javascript: if (!/^(\d{1,5}?)?$/.test(this.value)) this.value = this.value.slice(0, -1);"
                    (keyup)="validateMessage($event, i)"
                    (focusout)="enterQty($event, i)"
                    [attr.data-index]="i"
                  />
                  <span class="error" *ngIf="excesedQty.get(item.value.id)">
                    Please enter the Quantity less than remaining quantity
                  </span>
                  <span
                    class="error"
                    *ngIf="
                      !excesedQty.get(item.value.id) &&
                      item.controls.quantity.hasError('pattern')
                    "
                  >
                    Please enter Valid Quantity
                  </span>
                </mat-form-field>
              </div>
              <div class="divTableCell">
                <mat-form-field
                  class="custom-input mandatory"
                  floatLabel="never"
                  style="margin-top: 0px; max-width: 120px"
                >
                  <input
                    matInput
                    formControlName="unit_weight"
                    placeholder="Unit Weight"
                    readonly
                    [value]="item.value.unit_weight"
                    class="input-right"
                    type="text"
                  />
                </mat-form-field>
              </div>
              <div class="divTableCell">
                <mat-form-field
                  class="custom-input mandatory"
                  floatLabel="never"
                  style="margin-top: 0px; max-width: 120px"
                >
                  <input
                    matInput
                    formControlName="net_weight"
                    readonly
                    placeholder="Net Weight"
                    [value]="item.value.net_weight"
                    class="input-right"
                    type="number"
                  />
                </mat-form-field>
              </div>
              <div
                class="divTableCell"
                style="line-height: 72px; text-align: center"
              >
                <mat-icon
                  title="Delete"
                  (click)="deleteRow(i)"
                  style="cursor: pointer; vertical-align: super"
                  mat-button
                  >delete</mat-icon
                >
              </div>
            </div>
            <mat-error class="error-msg" *ngIf="productError">
              Please select atleast one product
            </mat-error>
          </div>
          <mat-error class="error-msg" *ngIf="productDetailserror">
            Please provide the details for the product.
          </mat-error>
        </div>
        <div
          *ngIf="excesedQty.has('addBtn') && excesedQty.get('addBtn')"
          class="order-totals-wrapper"
        >
          <!-- *ngIf="disableAddbtn" -->
          <div class="order-left-nav d-flex">
            <div class="add-new-line" (click)="addNewLine()">
              <img [src]="newItemIcon" alt="" />
              <span>Add Product</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div style="padding: 12px 0px"></div>
    <mat-error *ngIf="quantityErr"
      >Entered Quantity is higher than the Order Quantity</mat-error
    >
  </div>
</mat-dialog-content>
<mat-spinner
  class="medium-spinner page-fixed"
  *ngIf="fetchingData"
></mat-spinner>
<mat-dialog-actions>
  <span fxFlex></span>
  <button type="button"  class="back-btn-ui" mat-dialog-close>
    {{ language.defaults.cancel }}
  </button>
  <button
    [disabled]="
      containerForm.invalid || !excesedQty.get('submit') || createbtnDisabled
    "
    type="submit"
    (click)="createContainer(containerForm)"
    mat-raised-button
  >
    Submit
  </button>
</mat-dialog-actions>
