<mat-toolbar>
  <div class="flex-fixed-header menu-title">
    <h2 style="font-weight: 400" title="{{ addContainers }}">
      {{ addContainers }}
    </h2>
  </div>
</mat-toolbar>

<mat-dialog-content>
  <div [formGroup]="containerForm">
    <div
      class="min-container"
      [class.user-footer]="containerForm.dirty"
      formArrayName="containerItem"
      *ngFor="
        let item of containerForm.get('containerItem')['controls'];
        let i = index
      "
      style="
        border-bottom: 1px solid #bdc4cc;
        padding-bottom: 15px;
        padding-top: 15px;
      "
    >
      <div [formGroupName]="i">
        <div>
          <!-- <mat-form-field appearance="fill"> -->
            <input
              type="hidden"
              formControlName="container_id"
              [value]="item.container_id"
            />
          <!-- </mat-form-field> -->
        </div>
        
        <div class="ex-row">
          <mat-checkbox
            class="example-margin"
            formControlName="palletType"
            (change)="changePackageType($event, i)"
            [(ngModel)]="item.value.palletType"
            >Pallet</mat-checkbox
          >
        </div>
        <div *ngIf="data.product.batch_exists" class="ex-row">
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label
                class="custom-label mandatory"
                style="text-transform: unset"
                >Batch</mat-label
              >
            </div>
            <!-- (click)="onBatchClick()" -->

            <mat-select
              (selectionChange)="onBatchChange()"
              formControlName="batch_id"
              placeholder="Select a Batch"
            >
              <!-- (click)="onBatchClick()" -->
              <!-- (blur)="onBatchClick()" -->
              <mat-option
                class="products-custom-mat-option"
                *ngFor="let batch of batchesList"
                [value]="batch.id"
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <div>{{ batch.batch_nbr }}</div>
                  <!-- *ngIf="showRemainQty" -->
                  <!-- *ngIf="showRemainQty" -->
                  <div style="margin-left: 20px">
                    ( Remaining Qty :
                    {{ batchQty.get(batch.id) | number : "1.4-4" }} )
                  </div>
                  <!-- <span> ............. {{ batchQty.get(batch.id) }}</span> -->
                </div>
              </mat-option>
            </mat-select>
            <mat-error *ngIf="item.controls.batch_id.hasError('required')">
              Please Select a Batch
            </mat-error>
            <span
              style="
                color: #f44336;
                margin-top: 4px;
                text-transform: capitalize;
                font-size: 11px;
              "
              *ngIf="batchesList.length < 1 && !isLoading"
            >
              No batch with remaining quantity available for the selected
              product</span
            >
            <span
              style="
                color: #f44336;
                margin-top: 4px;
                text-transform: capitalize;
                font-size: 11px;
              "
              *ngIf="onBatchExpired(item.value.batch_id)"
            >
              The selected batch has expired and is no longer available to
              select</span
            >
            <span
              style="
                color: #f44336;
                margin-top: 4px;
                text-transform: capitalize;
                font-size: 11px;
              "
              *ngIf="onBatchStatus(item.value.batch_id)"
            >
              The selected batch is currently inactive in the inventory
              system</span
            >
          </mat-form-field>
        </div>

        <div class="ex-row" *ngIf="item.value.palletType">
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory">
                Number of Pallets</mat-label
              >
              <mat-icon matSuffix class="icon" title="Number of Packages"
                >info</mat-icon
              >
            </div>

            <input
              matInput
              placeholder="Number of Pallets"
              type="text"
              formControlName="primary_quantity"
              (keyup)="updateBatchQty()"
              maxlength="5"
            />
            <mat-error
              *ngIf="item.controls.primary_quantity.hasError('required')"
            >
              Please Enter Valid Number of Pallets
            </mat-error>
            <mat-error
              *ngIf="
                !item.controls.primary_quantity.hasError('min') &&
                item.controls.primary_quantity.hasError('pattern')
              "
              style="text-transform: none"
            >
              Please Enter Valid Number of Pallets
            </mat-error>
            <mat-error
              *ngIf="item.controls.primary_quantity.hasError('maxValue')"
              style="text-transform: none"
            >
              {{ item.controls.primary_quantity.errors.message }}
            </mat-error>
            <mat-error
              *ngIf="item.controls.primary_quantity.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
          </mat-form-field>
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory"
                >Tare Weight of Pallet</mat-label
              >
            </div>
            <input
              matInput
              type="number"
              step="0.01"
              placeholder="Tare weight of Pallet"
              formControlName="primary_tare_weight"
              oninput="javascript:  if (!/^(\d+(\.\d{0,4})?)?$/.test(this.value)) this.value = this.value.slice(0, -1);"
            />
            <!-- <mat-icon class="i-icon-t" title="Number of containers to be added for package">info</mat-icon> -->
            <mat-error
              *ngIf="item.controls.primary_tare_weight.hasError('required')"
              style="text-transform: none"
            >
              Please Enter Tare Weight of Pallet
            </mat-error>
            <mat-error
              *ngIf="
                !item.controls.primary_tare_weight.hasError('min') &&
                item.controls.primary_tare_weight.hasError('pattern')
              "
            >
              Please Enter Up To 8 Characters With 4 Decimals Max"</mat-error
            >
            <mat-error
              *ngIf="item.controls.primary_tare_weight.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
          </mat-form-field>
        </div>

        <div class="ex-row">
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label custom-placeholder mandatory">
                {{
                  item.value.palletType
                    ? "Sub Packaging Type"
                    : "Packaging Type"
                }}</mat-label
              >
              <mat-icon matSuffix class="icon" title="Name of the Package Type"
                >info</mat-icon
              >
            </div>
            <input
              matInput
              placeholder="Name"
              formControlName="name"
              maxLength="15"
              type="text"
              class="fieldInput"
            />
            <mat-error
              *ngIf="
                item.controls.name.hasError('specialcharacters') ||
                item.controls.name.hasError('whitespace')
              "
            >
              Please Enter Valid
              {{ item.value.palletType ? "Sub " : "" }} Package Type
            </mat-error>
          </mat-form-field>
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory"
                >Number of {{ item.value.name }}
                {{ item.value.palletType ? "per Pallet " : "" }}</mat-label
              >
            </div>
            <input
              matInput
              type="text"
              placeholder="Number of {{ item.value.name }} {{
                item.value.palletType ? 'per Pallet ' : ''
              }}"
              formControlName="quantity"
              id="quantity"
              maxlength="5"
              max="65000"
              (keyup)="validatelegth($event)"
            />

            <span
              style="
                color: #f44336;
                margin-top: 4px;
                text-transform: capitalize;
                font-size: 11px;
              "
              *ngIf="batchQty.get(item.value.batch_id) < 0"
            >
              Sorry, the requested quantity exceeds the available batch quantity
              in inventory
            </span>
            <!-- <mat-icon class="i-icon-t" title="Number of containers to be added for package">info</mat-icon> -->
            <mat-error
              *ngIf="item.controls.quantity.hasError('required')"
              style="text-transform: none"
            >
              Please Enter Number of {{ item.value.name }}
              {{ item.value.palletType ? "per Pallet " : "" }}
            </mat-error>
            <mat-error
              *ngIf="
                !item.controls.quantity.hasError('min') &&
                item.controls.quantity.hasError('pattern')
              "
              style="text-transform: none"
            >
              Please Enter Valid Number of {{ item.value.name }}
              {{ item.value.palletType ? "per Pallet " : "" }}
            </mat-error>
            <mat-error
              *ngIf="item.controls.quantity.hasError('maxValue')"
              style="text-transform: none"
            >
              {{ item.controls.quantity.errors.message }}
            </mat-error>
            <mat-error
              *ngIf="item.controls.quantity.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
          </mat-form-field>
        </div>

        <div class="ex-row">
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory"
                >Number of Items Per {{ item.value.name }}</mat-label
              >
              <mat-icon
                matSuffix
                class="icon"
                title="Number of pieces, weight or volume of the product per package"
                >info</mat-icon
              >
            </div>

            <input
              matInput
              type="text"
              min="0"
              maxlength="10"
              max="99999999"
              placeholder="Capacity"
              formControlName="quantity_type"
              id="containerType"
              class="fieldInput"
              (keyup)="updateBatchQty()"
            />
            <span
              style="
                color: #f44336;
                margin-top: 4px;
                text-transform: capitalize;
                font-size: 11px;
              "
              *ngIf="batchQty.get(item.value.batch_id) < 0"
            >
              Sorry, the requested quantity exceeds the available batch quantity
              in inventory
            </span>
            <mat-error
              *ngIf="item.controls.quantity_type.hasError('required')"
              style="text-transform: none"
            >
              Please Enter Number of Items Per {{ item.value.name }}
            </mat-error>
            <mat-error
              *ngIf="
                !item.controls.quantity_type.hasError('min') &&
                item.controls.quantity_type.hasError('pattern')
              "
              style="text-transform: none"
            >
              Please Enter Valid Number of Items Per {{ item.value.name }}
            </mat-error>
            <mat-error
              *ngIf="item.controls.quantity_type.hasError('maxValue')"
              style="text-transform: none"
            >
              {{ item.controls.quantity_type.errors.message }}
            </mat-error>
            <mat-error
              *ngIf="item.controls.quantity_type.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
          </mat-form-field>

          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory"
                >Tare weight of {{ item.value.name }} (kgs)</mat-label
              >
            </div>
            <input
              type="number"
              matInput
              placeholder="Tare weight"
              formControlName="tare_weight"
              id="tare_weight"
              step="0.01"
              oninput="javascript:  if (!/^(\d+(\.\d{0,4})?)?$/.test(this.value)) this.value = this.value.slice(0, -1);"
            />
            <!-- <mat-icon class="i-icon-t" title="Weight of Empty Container">info</mat-icon> -->
            <mat-error *ngIf="item.controls.tare_weight.hasError('required')">
              Please Enter Tare Weight
            </mat-error>
            <mat-error
              *ngIf="
                !item.controls.tare_weight.hasError('min') &&
                item.controls.tare_weight.hasError('pattern')
              "
            >
              Please Enter Up To 8 Characters With 4 Decimals Max
            </mat-error>
            <mat-error
              *ngIf="item.controls.tare_weight.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
          </mat-form-field>
        </div>
        <div class="ex-row">
          <!-- <mat-form-field class="custom-input mandatory grid-six" floatLabel="never">
            <label class="custom-label mandatory">Unit weight (kgs)</label>
            <input matInput type="number" placeholder="Unit weight" formControlName="unit_weight" id="unit_weight" step="0.01" oninput="validity.valid||(value='')" />
            <mat-icon class="i-icon-t" title="Unit weight of item">info</mat-icon>
            <mat-error *ngIf="item.controls.unit_weight.hasError('required')">
              Please Enter Unit Weight
            </mat-error>
          </mat-form-field> -->
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory"
                >Net weight Per {{ item.value.name }} (kgs)</mat-label
              >
              <mat-icon
                matSuffix
                class="icon"
                title="Net weight Per {{ item.value.name }}"
                >info</mat-icon
              >
            </div>
            <input
              matInput
              type="number"
              class="fieldInput"
              placeholder="Net weight"
              formControlName="net_weight"
              id="net_weight"
              step="0.01"
              oninput="javascript:  if (!/^(\d+(\.\d{0,4})?)?$/.test(this.value)) this.value = this.value.slice(0, -1);"
            />
            <mat-error *ngIf="item.controls.net_weight.hasError('required')">
              Please Enter Net Weight
            </mat-error>
            <mat-error
              *ngIf="
                !item.controls.net_weight.hasError('min') &&
                item.controls.net_weight.hasError('pattern')
              "
            >
              Please Enter Up To 8 Characters With 4 Decimals Max</mat-error
            >

            <mat-error
              *ngIf="item.controls.net_weight.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
          </mat-form-field>
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
            *ngIf="item.value.palletType"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory"
                >Net weight Per Pallet (kgs)</mat-label
              >
              <mat-icon
                matSuffix
                class="icon"
                title="Number of {{
                  item.value.name
                }} per Pallet*Net Weight Per {{ item.value.name }}"
                >info</mat-icon
              >
            </div>
            <input
              matInput
              type="number"
              placeholder="Net weight"
              class="current-series"
              formControlName="primary_net_weight"
              step="0.01"
              value="{{ item.value.quantity * item.value.net_weight }}"
              readonly
            />
          </mat-form-field>
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label
                class="custom-label mandatory"
                style="white-space: nowrap"
                >Gross weight Per
                {{ item.value.palletType ? "Pallet" : item.value.name }}
                (kgs)</mat-label
              >
              <mat-icon
                matSuffix
                class="icon"
                title="{{
                  item.value.palletType
                    ? '(Number of ' +
                      item.value.name +
                      ' per pallet * Tare weight of ' +
                      item.value.name +
                      ') + Tare weight of pallet + (Net weight of ' +
                      item.value.name +
                      ' * Number of ' +
                      item.value.name +
                      ' per pallet)'
                    : 'Tare Weight Per ' +
                      item.value.name +
                      ' + Net Weight Per ' +
                      item.value.name
                }}"
                >info</mat-icon
              >
            </div>
            <input
              matInput
              type="number"
              placeholder="Gross weight"
              class="current-series"
              formControlName="gross_weight"
              [value]="
                item.value.palletType
                  ? item.value.quantity * item.value.tare_weight +
                    +item.value.primary_tare_weight +
                    +item.value.net_weight * item.value.quantity
                  : +item.value.tare_weight + +item.value.net_weight
              "
              readonly
            />
          </mat-form-field>
        </div>
        <div class="ex-row">
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label
                class="custom-label mandatory"
                style="text-transform: unset"
                >Unit of Measurement</mat-label
              >
              <mat-icon
                matSuffix
                class="icon"
                title="UOM for package dimensions"
                >info</mat-icon
              >
            </div>
            <mat-select
              placeholder="Unit of Measurement"
              formControlName="uom_id"
              (selectionChange)="selectType($event, i)"
            >
              <mat-option
                [value]="stat.id"
                *ngFor="let stat of adminService.uomData"
                [innerHtml]="stat.name"
              ></mat-option>
            </mat-select>

            <mat-error *ngIf="item.controls.uom_id.hasError('required')">
              Please Select UOM
            </mat-error>
          </mat-form-field>
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory text-transform-none">
                {{ language.defaults.height }}&nbsp;<span
                  *ngIf="item.value.selectUnits"
                  >({{ item.value.selectUnits }})</span
                >
              </mat-label>
            </div>
            <input
              matInput
              type="number"
              min="0"
              max="9999.99"
              step="0.01"
              placeholder="Height"
              formControlName="height"
              id="containerHeight"
              oninput="javascript:  if (!/^(\d+(\.\d{0,4})?)?$/.test(this.value)) this.value = this.value.slice(0, -1);"
            />
            <mat-error *ngIf="item.controls.height.hasError('required')">
              Please Enter Height
            </mat-error>
            <mat-error
              *ngIf="item.controls.height.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
            <mat-error
              *ngIf="
                !item.controls.height.hasError('min') &&
                item.controls.height.hasError('pattern')
              "
            >
              Please Enter Up To 4 Characters With 4 Decimals Max</mat-error
            >
          </mat-form-field>
        </div>
        <div class="ex-row">
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory text-transform-none">
                {{ language.defaults.width }}&nbsp;
                <span *ngIf="item.value.selectUnits"
                  >({{ item.value.selectUnits }})</span
                >
              </mat-label>
            </div>
            <input
              matInput
              type="number"
              min="0"
              max=""
              step="0.01"
              placeholder="Width"
              formControlName="weight"
              id="containerWeight"
              oninput="javascript:  if (!/^(\d+(\.\d{0,4})?)?$/.test(this.value)) this.value = this.value.slice(0, -1);"
            />
            <mat-error *ngIf="item.controls.weight.hasError('required')">
              Please Enter Width
            </mat-error>
            <mat-error
              *ngIf="item.controls.weight.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
            <mat-error
              *ngIf="
                !item.controls.weight.hasError('min') &&
                item.controls.weight.hasError('pattern')
              "
              style="text-transform: none"
            >
              Please Enter Up To 4 Characters With 4 Decimals Max</mat-error
            >
          </mat-form-field>
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            step="0.01"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory text-transform-none">
                {{ language.defaults.depth }}&nbsp;<span
                  *ngIf="item.value.selectUnits"
                  >({{ item.value.selectUnits }})</span
                >
              </mat-label>
            </div>
            <input
              matInput
              type="number"
              min="0"
              max="99999999999"
              step="0.01"
              oninput="javascript:  if (!/^(\d+(\.\d{0,4})?)?$/.test(this.value)) this.value = this.value.slice(0, -1);"
              placeholder="Depth"
              formControlName="dimensions"
              id="containerDimensions"
            />
            <mat-error *ngIf="item.controls.dimensions.hasError('required')">
              Please Enter Depth
            </mat-error>
            <mat-error
              *ngIf="item.controls.dimensions.hasError('min')"
              style="text-transform: none"
            >
              Please Enter a Number Greater Than Zero</mat-error
            >
            <mat-error
              *ngIf="
                !item.controls.dimensions.hasError('min') &&
                item.controls.dimensions.hasError('pattern')
              "
              style="text-transform: none"
            >
              Please Enter Up To 4 Characters With 4 Decimals Max</mat-error
            >
          </mat-form-field>
        </div>
        <div class="ex-row">
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory"
                >Total Net Weight (kgs)</mat-label
              >
              <mat-icon
                matSuffix
                class="icon"
                title="{{
                  item.value.palletType
                    ? 'No. of Pallets * (No. of cartons per pallet * net weight per carton)'
                    : 'Number of ' +
                      item.value.name +
                      '*Net Weight of ' +
                      item.value.name
                }}"
                >info</mat-icon
              >
            </div>
            <input
              matInput
              type="number"
              placeholder="Total Net weight"
              class="current-series"
              formControlName="total_net_weight"
              [value]="
                item.value.palletType
                  ? item.value.primary_quantity *
                    (item.value.quantity * item.value.net_weight)
                  : item.value.net_weight * item.value.quantity
              "
              readonly
            />
          </mat-form-field>
          <mat-form-field
            class="custom-input-field mandatory grid-six"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label mandatory"
                >Total Gross Weight (kgs)</mat-label
              >
              <mat-icon
                matSuffix
                class="icon"
                title="{{
                  item.value.palletType
                    ? 'Number of Pallets * ((' +
                      'Number of ' +
                      item.value.name +
                      ' per pallet * Tare weight of ' +
                      item.value.name +
                      ') + Tare weight of pallet + (Net weight of ' +
                      item.value.name +
                      ' * Number of ' +
                      item.value.name +
                      ' per pallet))'
                    : 'Total Net Weight + (Number of ' +
                      item.value.name +
                      ' * Tare Weight of ' +
                      item.value.name +
                      ')'
                }}"
              >
                info</mat-icon
              >
            </div>
            <input
              matInput
              type="number"
              placeholder="Total Gross weight"
              class="current-series"
              formControlName="total_gross_weight"
              [value]="
                item.value.palletType
                  ? item.value.primary_quantity *
                    (item.value.quantity * item.value.tare_weight +
                      +item.value.primary_tare_weight +
                      +item.value.net_weight * item.value.quantity)
                  : item.value.quantity * item.value.tare_weight +
                    +item.value.net_weight * item.value.quantity
              "
              readonly
            />
          </mat-form-field>
        </div>
        <div class="ex-row">
          <mat-form-field
            class="custom-input-field grid-full"
            floatLabel="always"
          >
            <div class="label-container">
              <mat-label class="custom-label">Inner Description</mat-label>
            </div>
            <textarea
              matInput
              maxlength="255"
              placeholder="Inner Description"
              formControlName="inner_description"
              id="ContainerDesc"
            ></textarea>
          </mat-form-field>
        </div>
      </div>
      <div class="d-flex" style="justify-content: flex-end" *ngIf="i > 0">
        <span class="add-batch add-Line m_t_10">
          <span
            class="edit-batch delete"
            (click)="deleteRow(i)"
            title="delete package"
            >delete package</span
          >
        </span>
      </div>
    </div>
    <p class="quantity-info" [ngClass]="isQuantityValid ? 'c-green' : 'c-red'">
      {{ addedWeight }} out of {{ data.product?.product_quantity }} Quantity
      Added. {{ remainingWeight | number : "1.4-4" }} Remaining
    </p>
    <div style="padding: 12px 0px">
      <button mat-raised-button (click)="addContainerRows()">
        Add More Packaging
      </button>
    </div>
    <mat-error *ngIf="quantityErr"
      >Entered Quantity is higher than the Order Quantity</mat-error
    >
  </div>
  <mat-spinner
    class="medium-spinner page-fixed"
    *ngIf="showSpinner"
  ></mat-spinner>
</mat-dialog-content>
<mat-dialog-actions>
  <span fxFlex></span>
  <button type="button"  class="back-btn-ui" mat-dialog-close>
    {{ language.defaults.cancel }}
  </button>
  <button
    type="submit"
    (click)="createContainer(containerForm)"
    [disabled]="
      containerForm.invalid ||
      createbtnDisabled ||
      batchError ||
      batch_Exp_status
    "
    mat-raised-button
  >
    Submit
  </button>
</mat-dialog-actions>
